<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - Task Buddy</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 36px;
        }

        .stat-card p {
            margin: 0;
            opacity: 0.9;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .users-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .view-btn {
            padding: 6px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .view-btn:hover {
            background: #5568d3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .task-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .task-item.deleted {
            border-left-color: #dc3545;
            background: #fee;
        }

        .task-item.completed {
            border-left-color: #28a745;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 8px;
        }

        .badge-deleted {
            background: #dc3545;
            color: white;
        }

        .badge-completed {
            background: #28a745;
            color: white;
        }

        .badge-active {
            background: #0984e3;
            color: white;
        }

        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }

        .back-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 style="color: #667eea; margin: 0;">üîê Admin Dashboard</h1>
            <div>
                <span id="adminEmail" style="margin-right: 15px; color: #666;"></span>
                <a href="index.html" class="back-btn">‚Üê Back to App</a>
            </div>
        </div>

        <h2 style="color: #667eea; margin-bottom: 20px;">üìä Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card">
                <h3 id="totalTasks">0</h3>
                <p>Total Tasks</p>
            </div>
            <div class="stat-card">
                <h3 id="activeTasks">0</h3>
                <p>Active Tasks</p>
            </div>
            <div class="stat-card">
                <h3 id="completedTasks">0</h3>
                <p>Completed</p>
            </div>
            <div class="stat-card">
                <h3 id="deletedTasks">0</h3>
                <p>Deleted Tasks</p>
            </div>
            <div class="stat-card">
                <h3 id="avgRating">0</h3>
                <p>Avg Rating ‚≠ê</p>
            </div>
        </div>

        <!-- Analytics Section -->
        <h2 style="color: #667eea; margin: 40px 0 20px 0;">üìà User Analytics</h2>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px;">üñ•Ô∏è Devices</h3>
                <div id="deviceStats"></div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px;">üåê Browsers</h3>
                <div id="browserStats"></div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px;">üíª Operating Systems</h3>
                <div id="osStats"></div>
            </div>
        </div>

        <!-- Recent Activities -->
        <h2 style="color: #667eea; margin: 40px 0 20px 0;">üìã Recent Activities</h2>
        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-height: 400px; overflow-y: auto;">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Action</th>
                        <th>Device</th>
                        <th>Browser/OS</th>
                        <th>IP Address</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="activitiesTable">
                    <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <h2 style="color: #667eea; margin: 40px 0 20px 0;">üë• Users</h2>
        <table class="users-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Joined</th>
                    <th>Tasks</th>
                    <th>Completed</th>
                    <th>Deleted</th>
                    <th>Admin</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTable">
                <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
            </tbody>
        </table>

        <h2 style="color: #667eea; margin: 40px 0 20px 0;">üìã All Tasks Activity</h2>
        <div style="margin-bottom: 15px;">
            <button onclick="filterTasks('all')" style="padding: 8px 15px; margin-right: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">All</button>
            <button onclick="filterTasks('active')" style="padding: 8px 15px; margin-right: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Active</button>
            <button onclick="filterTasks('completed')" style="padding: 8px 15px; margin-right: 10px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">Completed</button>
            <button onclick="filterTasks('deleted')" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Deleted</button>
        </div>
        <div id="allTasksContainer" style="max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <p style="text-align: center; color: #666;">Loading all tasks...</p>
        </div>
    </div>

    <!-- Modal for viewing user tasks -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="color: #667eea;">User Tasks</h2>
            <div id="modalTasks"></div>
        </div>
    </div>

    <script>
        // Check admin auth
        async function checkAdminAuth() {
            try {
                const response = await fetch('http://127.0.0.1:5000/check-auth', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.authenticated || !data.is_admin) {
                    alert('Admin access only!');
                    window.location.href = 'login.html';
                    return false;
                }
                
                document.getElementById('adminEmail').textContent = data.email;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('http://127.0.0.1:5000/admin/stats', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('totalTasks').textContent = data.total_tasks;
                document.getElementById('activeTasks').textContent = data.active_tasks;
                document.getElementById('completedTasks').textContent = data.completed_tasks;
                document.getElementById('deletedTasks').textContent = data.deleted_tasks;
                document.getElementById('avgRating').textContent = data.avg_rating;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const response = await fetch('http://127.0.0.1:5000/admin/analytics', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                // Display device stats
                const deviceStats = document.getElementById('deviceStats');
                deviceStats.innerHTML = Object.entries(data.devices).map(([device, count]) => 
                    `<div style="margin: 5px 0;"><strong>${device}:</strong> ${count}</div>`
                ).join('');
                
                // Display browser stats
                const browserStats = document.getElementById('browserStats');
                browserStats.innerHTML = Object.entries(data.browsers).map(([browser, count]) => 
                    `<div style="margin: 5px 0;"><strong>${browser}:</strong> ${count}</div>`
                ).join('');
                
                // Display OS stats
                const osStats = document.getElementById('osStats');
                osStats.innerHTML = Object.entries(data.operating_systems).map(([os, count]) => 
                    `<div style="margin: 5px 0;"><strong>${os}:</strong> ${count}</div>`
                ).join('');
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        // Load recent activities
        async function loadActivities() {
            try {
                const response = await fetch('http://127.0.0.1:5000/admin/activities?limit=50', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                const tbody = document.getElementById('activitiesTable');
                tbody.innerHTML = '';
                
                if (data.activities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No activities yet</td></tr>';
                } else {
                    data.activities.forEach(activity => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${activity.user_email}</td>
                            <td><strong>${activity.action.replace('_', ' ')}</strong><br><small style="color: #666;">${activity.details || ''}</small></td>
                            <td>${activity.device_type || 'unknown'}</td>
                            <td>${activity.browser || 'unknown'} / ${activity.os || 'unknown'}</td>
                            <td><small>${activity.ip_address || 'N/A'}</small></td>
                            <td><small>${activity.timestamp ? new Date(activity.timestamp).toLocaleString() : 'N/A'}</small></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Failed to load activities:', error);
            }
        }

        // Load statistics
        async function loadUsers() {
            try {
                const response = await fetch('http://127.0.0.1:5000/admin/users', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                        <td>${user.task_count}</td>
                        <td>${user.completed_count}</td>
                        <td>${user.deleted_count}</td>
                        <td>${user.is_admin ? '‚úÖ' : '‚ùå'}</td>
                        <td>
                            <button class="view-btn" onclick="viewUserTasks(${user.id}, '${user.email}')">
                                View Tasks
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        // View user tasks
        async function viewUserTasks(userId, email) {
            try {
                const response = await fetch(`http://127.0.0.1:5000/admin/user/${userId}/tasks`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                document.getElementById('modalTitle').textContent = `Tasks for ${email}`;
                const modalTasks = document.getElementById('modalTasks');
                modalTasks.innerHTML = '';
                
                if (data.tasks.length === 0) {
                    modalTasks.innerHTML = '<p>No tasks found.</p>';
                } else {
                    data.tasks.forEach(task => {
                        const div = document.createElement('div');
                        div.className = 'task-item';
                        if (task.is_deleted) div.classList.add('deleted');
                        else if (task.completed) div.classList.add('completed');
                        
                        let badges = '';
                        if (task.is_deleted) badges += '<span class="badge badge-deleted">DELETED</span>';
                        else if (task.completed) badges += '<span class="badge badge-completed">COMPLETED</span>';
                        else badges += '<span class="badge badge-active">ACTIVE</span>';
                        
                        div.innerHTML = `
                            <strong>${task.text}</strong> ${badges}
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Priority: ${task.priority} | Category: ${task.category}<br>
                                Created: ${task.created_at ? new Date(task.created_at).toLocaleString() : 'N/A'}
                                ${task.deleted_at ? `<br>Deleted: ${new Date(task.deleted_at).toLocaleString()}` : ''}
                            </div>
                        `;
                        modalTasks.appendChild(div);
                    });
                }
                
                document.getElementById('taskModal').classList.add('show');
            } catch (error) {
                console.error('Failed to load user tasks:', error);
                alert('Failed to load tasks');
            }
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('show');
        }

        // Load all tasks
        let allTasksData = [];
        let currentFilter = 'all';

        async function loadAllTasks() {
            try {
                const response = await fetch('http://127.0.0.1:5000/admin/all-tasks', {
                    credentials: 'include'
                });
                const data = await response.json();
                allTasksData = data.tasks;
                displayFilteredTasks();
            } catch (error) {
                console.error('Failed to load all tasks:', error);
            }
        }

        function filterTasks(filter) {
            currentFilter = filter;
            displayFilteredTasks();
        }

        function displayFilteredTasks() {
            const container = document.getElementById('allTasksContainer');
            
            let filtered = allTasksData;
            if (currentFilter === 'active') {
                filtered = allTasksData.filter(t => !t.is_deleted && !t.completed);
            } else if (currentFilter === 'completed') {
                filtered = allTasksData.filter(t => t.completed && !t.is_deleted);
            } else if (currentFilter === 'deleted') {
                filtered = allTasksData.filter(t => t.is_deleted);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No tasks found.</p>';
                return;
            }

            container.innerHTML = '';
            filtered.forEach(task => {
                const div = document.createElement('div');
                div.className = 'task-item';
                if (task.is_deleted) div.classList.add('deleted');
                else if (task.completed) div.classList.add('completed');
                
                let badges = '';
                if (task.is_deleted) badges += '<span class="badge badge-deleted">DELETED</span>';
                else if (task.completed) badges += '<span class="badge badge-completed">COMPLETED</span>';
                else badges += '<span class="badge badge-active">ACTIVE</span>';
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${task.text}</strong> ${badges}
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                <strong>User:</strong> ${task.user_email} | 
                                <strong>Priority:</strong> ${task.priority} | 
                                <strong>Category:</strong> ${task.category}<br>
                                <strong>Created:</strong> ${task.created_at ? new Date(task.created_at).toLocaleString() : 'N/A'}
                                ${task.completed_at ? `<br><strong>Completed:</strong> ${new Date(task.completed_at).toLocaleString()}` : ''}
                                ${task.deleted_at ? `<br><strong>Deleted:</strong> ${new Date(task.deleted_at).toLocaleString()}` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Initialize
        async function init() {
            const isAdmin = await checkAdminAuth();
            if (isAdmin) {
                await loadStats();
                await loadAnalytics();
                await loadActivities();
                await loadUsers();
                await loadAllTasks();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    loadStats();
                    loadAnalytics();
                    loadActivities();
                    loadUsers();
                    loadAllTasks();
                }, 30000);
            }
        }

        init();

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('taskModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
